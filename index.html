<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­æœ¬è”¡è‡ªåˆ¶çœ‹ç›˜</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ApexCharts for the K-line chart -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #333; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
        
        .glass-panel {
            background: rgba(30, 30, 30, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .chart-container {
            min-height: 400px;
        }
        
        /* Animation for live price pulse */
        @keyframes pulse-green {
            0% { text-shadow: 0 0 0 rgba(16, 185, 129, 0); }
            50% { text-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
            100% { text-shadow: 0 0 0 rgba(16, 185, 129, 0); }
        }
        @keyframes pulse-red {
            0% { text-shadow: 0 0 0 rgba(239, 68, 68, 0); }
            50% { text-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }
            100% { text-shadow: 0 0 0 rgba(239, 68, 68, 0); }
        }
        .pulse-up { animation: pulse-green 2s infinite; }
        .pulse-down { animation: pulse-red 2s infinite; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="border-b border-gray-800 bg-gray-900/90 sticky top-0 z-50 backdrop-blur-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center text-white font-bold">â‚¿</div>
                    <span class="text-xl font-bold tracking-wider text-white">ä¸­æœ¬è”¡è‡ªåˆ¶çœ‹ç›˜</span>
                </div>
                <div class="flex items-center gap-4">
                    <div class="hidden md:block text-xs text-gray-500 bg-gray-800 px-3 py-1 rounded-full">
                        ç”¨æˆ·: Master
                    </div>
                    <div class="text-xs text-gray-400" id="clock">00:00:00</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8 space-y-6">

        <!-- Top Section: Price & Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Main Price Card -->
            <div class="glass-panel rounded-2xl p-6 md:col-span-1 flex flex-col justify-center relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-32 w-32" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                    </svg>
                </div>
                <h2 class="text-gray-400 text-sm font-medium uppercase tracking-wide mb-1">Bitcoin (BTC) ç°ä»·</h2>
                <div class="flex items-baseline gap-2">
                    <span class="text-gray-400 text-2xl font-light">$</span>
                    <span id="btc-price" class="text-5xl font-bold text-white tracking-tighter pulse-up">--,--</span>
                </div>
                <div class="mt-4 flex items-center gap-2">
                    <span id="price-change-pill" class="px-2 py-1 rounded text-sm font-bold bg-gray-800 text-gray-400">
                        --%
                    </span>
                    <span class="text-gray-500 text-sm">24å°æ—¶æ¶¨è·Œ</span>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="md:col-span-2 grid grid-cols-2 sm:grid-cols-4 gap-4">
                <div class="glass-panel rounded-xl p-4 flex flex-col justify-center">
                    <span class="text-gray-500 text-xs">24H æœ€é«˜</span>
                    <span id="high-24h" class="text-lg font-semibold text-gray-200">Loading...</span>
                </div>
                <div class="glass-panel rounded-xl p-4 flex flex-col justify-center">
                    <span class="text-gray-500 text-xs">24H æœ€ä½</span>
                    <span id="low-24h" class="text-lg font-semibold text-gray-200">Loading...</span>
                </div>
                <div class="glass-panel rounded-xl p-4 flex flex-col justify-center">
                    <span class="text-gray-500 text-xs">æ€»å¸‚å€¼</span>
                    <span class="text-lg font-semibold text-gray-200">$1.8T</span>
                </div>
                <div class="glass-panel rounded-xl p-4 flex flex-col justify-center">
                    <span class="text-gray-500 text-xs">å¸‚åœºæƒ…ç»ª</span>
                    <span class="text-lg font-semibold text-green-400">è´ªå©ª (72)</span>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="glass-panel rounded-2xl p-1 shadow-2xl shadow-black/50">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center">
                <h3 class="font-semibold text-gray-300" id="chart-title">BTC/USDT è¿‘åŠå¹´ Kçº¿å›¾</h3>
                <div class="flex gap-2">
                    <!-- These buttons are for future feature, currently hardcoded to 180 days (Day) -->
                    <button class="px-3 py-1 text-xs rounded bg-gray-800 text-white transition">æ—¥çº¿ (180å¤©)</button>
                    <button class="px-3 py-1 text-xs rounded bg-transparent text-gray-500 transition">4å°æ—¶</button>
                </div>
            </div>
            <div id="chart" class="w-full h-96 bg-gray-900/50">
                <div class="text-center py-20 text-gray-400">æ­£åœ¨åŠ è½½çœŸå®å†å²Kçº¿æ•°æ®...</div>
            </div>
        </div>

        <!-- News Section -->
        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <span class="w-1 h-6 bg-orange-500 rounded-full"></span>
                    çƒ­é—¨èµ„è®¯
                </h3>
                <span class="text-xs text-gray-500 animate-pulse">â— å®æ—¶æ›´æ–°ä¸­</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="news-container">
                <!-- News items will be injected here via JS -->
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="border-t border-gray-800 mt-12 py-8 bg-gray-900">
        <div class="max-w-7xl mx-auto px-4 text-center text-gray-600 text-sm">
            <p>&copy; 2025 ä¸­æœ¬è”¡è‡ªåˆ¶çœ‹ç›˜. All rights reserved.</p>
            <p class="mt-2 text-xs">æ•°æ®ä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚</p>
        </div>
    </footer>

    <script>
        // --- Configuration & Endpoints ---
        // CoinGecko API Endpoints
        const PRICE_API_ENDPOINT = 'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true&include_24hr_high=true&include_24hr_low=true';
        // OHLC endpoint for 180 days of historical data
        const CHART_API_ENDPOINT = 'https://api.coingecko.com/api/v3/coins/bitcoin/ohlc?vs_currency=usd&days=180';

        // --- Utilities ---
        const formatCurrency = (num) => {
            if (typeof num !== 'number' || isNaN(num) || num === null) {
                return 'N/A';
            }
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        };

        const updateClock = () => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('zh-CN', { hour12: false });
        };
        setInterval(updateClock, 1000);
        updateClock();
        
        // --- Robust Fetch with Exponential Backoff ---
        async function fetchWithRetry(url, maxRetries = 5, initialDelay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error; // Throw if it's the last attempt
                    }
                    const delay = initialDelay * Math.pow(2, i);
                    // console.log(`Fetch failed for ${url}. Retrying in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        // --- Data Logic (API) ---
        
        // Mock News Data (Still required as CoinGecko simple API doesn't provide news)
        const newsData = [
            { title: "è´è±å¾·ç°è´§æ¯”ç‰¹å¸ ETF äº¤æ˜“é‡å†åˆ›æ–°é«˜", desc: "éšç€æœºæ„æŠ•èµ„è€…å…´è¶£çš„æŒç»­å‡æ¸©ï¼ŒIBIT æ˜¨æ—¥äº¤æ˜“é‡çªç ´å†å²è®°å½•ï¼Œåå°”è¡—å¯¹åŠ å¯†èµ„äº§çš„é…ç½®æ­£åœ¨åŠ é€Ÿã€‚", time: "15åˆ†é’Ÿå‰", tag: "æœºæ„åŠ¨å‘", sentiment: "up" },
            { title: "ç¾è”å‚¨æš—ç¤ºé™æ¯å‘¨æœŸä¸´è¿‘ï¼Œæ¯”ç‰¹å¸çªç ´å…³é”®é˜»åŠ›ä½", desc: "æœ€æ–°çš„ FOMC ä¼šè®®çºªè¦æ˜¾ç¤ºï¼Œé€šèƒ€æ•°æ®æ”¾ç¼“å¯èƒ½ä¿ƒä½¿ç¾è”å‚¨åœ¨ä¸‹ä¸ªå­£åº¦å¼€å§‹é™æ¯ï¼Œé£é™©èµ„äº§æ™®æ¶¨ã€‚", time: "1å°æ—¶å‰", tag: "å®è§‚ç»æµ", sentiment: "up" },
            { title: "æŸç¥ç§˜å·¨é²¸åœ°å€ä¼‘çœ  10 å¹´åè‹é†’ï¼Œè½¬ç§» 500 BTC", desc: "é“¾ä¸Šæ•°æ®æ˜¾ç¤ºï¼Œä¸€ä¸ªè‡ª 2014 å¹´ä»¥æ¥æœªæ›¾æ´»è·ƒçš„é’±åŒ…ä»Šæ—¥æ—©äº›æ—¶å€™è¿›è¡Œäº†å¤§é¢è½¬è´¦ï¼Œå¼•å‘å¸‚åœºå¯¹æŠ›å‹çš„æ‹…å¿§ã€‚", time: "2å°æ—¶å‰", tag: "é“¾ä¸Šæ•°æ®", sentiment: "down" },
            { title: "ä»¥å¤ªåŠåæ˜†å‡çº§æŠ€æœ¯å›é¡¾ï¼šLayer2 æ‰‹ç»­è´¹å¤§å¹…é™ä½", desc: "å°½ç®¡å¸‚åœºç„¦ç‚¹åœ¨æ¯”ç‰¹å¸ï¼Œä½†ä»¥å¤ªåŠç”Ÿæ€çš„ Gas è´¹ç”¨æ˜¾è‘—ä¸‹é™ï¼Œå¸¦åŠ¨äº† DeFi æ¿å—çš„æ´»è·ƒåº¦å›å‡ã€‚", time: "3å°æ—¶å‰", tag: "æŠ€æœ¯å‡çº§", sentiment: "neutral" },
            { title: "é¦™æ¸¯è¯ç›‘ä¼šæ‰¹å‡†æ–°çš„è™šæ‹Ÿèµ„äº§äº¤æ˜“å¹³å°ç‰Œç…§", desc: "äºšæ´²åŠ å¯†é‡‘èä¸­å¿ƒå»ºè®¾ç¨³æ­¥æ¨è¿›ï¼Œåˆè§„åŒ–è¿›ç¨‹åŠ é€Ÿï¼Œå¸å¼•äº†æ›´å¤šä¼ ç»Ÿé‡‘èæœºæ„å…¥åœºã€‚", time: "4å°æ—¶å‰", tag: "ç›‘ç®¡æ”¿ç­–", sentiment: "up" },
            { title: "åˆ†æå¸ˆï¼šæ¯”ç‰¹å¸å‡åŠåæ•ˆåº”é€šå¸¸æ»å 6-12 ä¸ªæœˆ", desc: "å†å²æ•°æ®æ˜¾ç¤ºï¼Œä¾›åº”å†²å‡»å¸¦æ¥çš„ä»·æ ¼ä¸Šæ¶¨å¾€å¾€ä¸ä¼šç«‹å³å‘ç”Ÿï¼ŒæŠ•èµ„è€…éœ€ä¿æŒè€å¿ƒã€‚", time: "5å°æ—¶å‰", tag: "å¸‚åœºåˆ†æ", sentiment: "neutral" }
        ];

        // --- Render Functions ---

        function renderNews() {
            const container = document.getElementById('news-container');
            container.innerHTML = newsData.map(news => `
                <div class="glass-panel p-5 rounded-xl border-l-4 ${news.sentiment === 'up' ? 'border-green-500' : (news.sentiment === 'down' ? 'border-red-500' : 'border-gray-500')} hover:bg-gray-800 transition cursor-pointer group">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-bold text-gray-500 bg-gray-900 px-2 py-0.5 rounded">${news.tag}</span>
                        <span class="text-xs text-gray-500">${news.time}</span>
                    </div>
                    <h4 class="text-gray-200 font-bold mb-2 group-hover:text-orange-400 transition">${news.title}</h4>
                    <p class="text-gray-400 text-sm line-clamp-2">${news.desc}</p>
                </div>
            `).join('');
        }

        let chart; // Global chart instance

        function initChart(seriesData) {
            const options = {
                series: [{
                    data: seriesData
                }],
                chart: {
                    type: 'candlestick',
                    height: 350,
                    background: 'transparent',
                    toolbar: { show: false },
                    animations: { enabled: true }
                },
                theme: {
                    mode: 'dark'
                },
                plotOptions: {
                    candlestick: {
                        colors: {
                            upward: '#10B981', // Tailwind Green 500
                            downward: '#EF4444' // Tailwind Red 500
                        },
                        wick: { useFillColor: true }
                    }
                },
                xaxis: {
                    type: 'datetime',
                    axisBorder: { show: false },
                    axisTicks: { show: false },
                    tooltip: { enabled: true }
                },
                yaxis: {
                    tooltip: { enabled: true },
                    labels: {
                        formatter: function (value) { return "$" + value.toFixed(0); }
                    }
                },
                grid: {
                    borderColor: '#333',
                    strokeDashArray: 4,
                }
            };

            if (chart) {
                chart.updateSeries([{ data: seriesData }]);
            } else {
                chart = new ApexCharts(document.querySelector("#chart"), options);
                chart.render();
            }
        }

        // --- Main Execution Flow ---

        async function updateDashboard() {
            try {
                // 1. Fetch Price - ä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥å°è¯•è·å–å®æ—¶ä»·æ ¼
                const priceData = await fetchWithRetry(PRICE_API_ENDPOINT);
                
                const btc = priceData.bitcoin;
                
                // ä½¿ç”¨ API æ•°æ®
                const currentPrice = btc.usd;
                const high24h = btc.usd_24h_high;
                const low24h = btc.usd_24h_low;
                const changeValue = btc.usd_24h_change;

                // Update DOM
                const currentPriceEl = document.getElementById('btc-price');
                const prevPrice = parseFloat(currentPriceEl.innerText.replace(/,/g, ''));
                
                // Animation logic
                if (!isNaN(prevPrice) && prevPrice !== 0) {
                    currentPriceEl.className = `text-5xl font-bold tracking-tighter ${currentPrice >= prevPrice ? 'text-green-500 pulse-up' : 'text-red-500 pulse-down'}`;
                    setTimeout(() => {
                        currentPriceEl.className = 'text-5xl font-bold text-white tracking-tighter';
                    }, 2000);
                } else {
                    currentPriceEl.className = 'text-5xl font-bold text-white tracking-tighter'; // Initial state
                }

                currentPriceEl.innerText = formatCurrency(currentPrice);
                
                const changeEl = document.getElementById('price-change-pill');
                changeEl.innerText = (changeValue > 0 ? '+' : '') + (typeof changeValue === 'number' ? changeValue.toFixed(2) : '--') + '%';
                changeEl.className = `px-2 py-1 rounded text-sm font-bold ${changeValue >= 0 ? 'bg-green-900 text-green-400' : 'bg-red-900 text-red-400'}`;

                // Use API values for high/low
                document.getElementById('high-24h').innerText = '$' + formatCurrency(high24h);
                document.getElementById('low-24h').innerText = '$' + formatCurrency(low24h);

            } catch (error) {
                // 2. Fallback to Error State if all retries fail
                console.error("æ— æ³•è·å–å®æ—¶ä»·æ ¼æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–APIçŠ¶æ€ã€‚", error);

                document.getElementById('btc-price').innerText = 'API ERROR';
                document.getElementById('btc-price').className = 'text-5xl font-bold text-red-500 tracking-tighter';
                document.getElementById('high-24h').innerText = 'N/A';
                document.getElementById('low-24h').innerText = 'N/A';
                
                const changeEl = document.getElementById('price-change-pill');
                changeEl.innerText = '0.00%';
                changeEl.className = 'px-2 py-1 rounded text-sm font-bold bg-gray-800 text-gray-400';
            }
        }

        async function updateChart() {
            const chartEl = document.getElementById('chart');
            const chartTitleEl = document.getElementById('chart-title');
            chartEl.innerHTML = '<div class="text-center py-20 text-gray-400">æ­£åœ¨åŠ è½½çœŸå®å†å²Kçº¿æ•°æ®...</div>';

            try {
                // 1. Fetch historical OHLC data
                const ohlcData = await fetchWithRetry(CHART_API_ENDPOINT, 3); // Fewer retries for heavy chart data
                
                // 2. Map data to ApexCharts format: [timestamp, open, high, low, close] -> {x, y:[o,h,l,c]}
                const seriesData = ohlcData.map(item => ({
                    x: new Date(item[0]), // Timestamp
                    y: [item[1].toFixed(2), item[2].toFixed(2), item[3].toFixed(2), item[4].toFixed(2)] // OHLC values
                }));

                // 3. Render chart
                chartEl.innerHTML = ''; // Clear loading state
                initChart(seriesData);

                // 4. Update title
                chartTitleEl.innerText = 'BTC/USDT è¿‘åŠå¹´ Kçº¿å›¾ (çœŸå®æ•°æ®)';

            } catch (error) {
                // 5. Fallback to Error State
                console.error("æ— æ³•è·å–çœŸå®å†å²Kçº¿æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–APIçŠ¶æ€ã€‚", error);
                chartTitleEl.innerText = 'BTC/USDT Kçº¿å›¾ (æ•°æ®åŠ è½½å¤±è´¥)';
                chartEl.innerHTML = '<div class="text-center py-20 text-red-400">ğŸš¨ æ— æ³•åŠ è½½çœŸå® K çº¿æ•°æ®ã€‚è¯·æ£€æŸ¥ API çŠ¶æ€ã€‚</div>';
            }
        }

        // --- Init ---
        window.addEventListener('DOMContentLoaded', () => {
            renderNews();
            updateDashboard(); // Initial load - å°è¯•è·å–å®æ—¶ä»·æ ¼
            updateChart();     // Initial Chart - è·å–çœŸå® K çº¿å›¾

            // æ¯ 10 ç§’å°è¯•è·å–ä¸€æ¬¡å®æ—¶ä»·æ ¼
            setInterval(updateDashboard, 10000);
        });

    </script>
</body>
</html>